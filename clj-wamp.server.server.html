<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><link href="css/default.css" rel="stylesheet" type="text/css" /><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>clj-wamp.server.server documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Clj-wamp</span> <span class="project-version">2.1.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-wamp</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>handler</span></div></div></li><li class="depth-4"><a href="clj-wamp.client.handler.error.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>error</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>info</span></div></div></li><li class="depth-3 branch"><a href="clj-wamp.info.ids.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ids</span></div></a></li><li class="depth-3"><a href="clj-wamp.info.uris.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>uris</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>libs</span></div></div></li><li class="depth-3 branch"><a href="clj-wamp.libs.channels.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>channels</span></div></a></li><li class="depth-3"><a href="clj-wamp.libs.helpers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>helpers</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>server</span></div></div></li><li class="depth-3 branch"><a href="clj-wamp.server.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch current"><a href="clj-wamp.server.server.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server</span></div></a></li><li class="depth-3"><a href="clj-wamp.server.v2.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>v2</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="clj-wamp.server.server.html#var-*call-sess-id*"><div class="inner"><span>*call-sess-id*</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-auth-challenge"><div class="inner"><span>auth-challenge</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-authorized.3F"><div class="inner"><span>authorized?</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-broadcast-event.21"><div class="inner"><span>broadcast-event!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-client-auth-requested.3F"><div class="inner"><span>client-auth-requested?</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-client-authenticated.3F"><div class="inner"><span>client-authenticated?</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-client-topics"><div class="inner"><span>client-topics</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-emit-event.21"><div class="inner"><span>emit-event!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-get-topic-clients"><div class="inner"><span>get-topic-clients</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-handle-message"><div class="inner"><span>handle-message</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-hmac-sha-256"><div class="inner"><span>hmac-sha-256</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-http-kit-handler"><div class="inner"><span>http-kit-handler</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-origin-match.3F"><div class="inner"><span>origin-match?</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-abort.21"><div class="inner"><span>send-abort!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-call-result.21"><div class="inner"><span>send-call-result!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-error.21"><div class="inner"><span>send-error!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-event.21"><div class="inner"><span>send-event!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-goodbye.21"><div class="inner"><span>send-goodbye!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-subscribed.21"><div class="inner"><span>send-subscribed!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-send-welcome.21"><div class="inner"><span>send-welcome!</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-subprotocol-id"><div class="inner"><span>subprotocol-id</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-subprotocol.3F"><div class="inner"><span>subprotocol?</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-topic-clients"><div class="inner"><span>topic-clients</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-topic-subscribe"><div class="inner"><span>topic-subscribe</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-topic-unsubscribe"><div class="inner"><span>topic-unsubscribe</span></div></a></li><li class="depth-1"><a href="clj-wamp.server.server.html#var-with-channel-validation"><div class="inner"><span>with-channel-validation</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">clj-wamp.server.server</h1><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-*call-sess-id*"><h3>*call-sess-id*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-auth-challenge"><h3>auth-challenge</h3><div class="usage"><code>(auth-challenge sess-id auth-key auth-secret)</code></div><div class="doc"><pre class="plaintext">Generates a challenge hash used by the client to sign the secret.
</pre></div></div><div class="public anchor" id="var-authorized.3F"><h3>authorized?</h3><div class="usage"><code>(authorized? sess-id category topic perm-cb)</code></div><div class="doc"><pre class="plaintext">Checks if the session is authorized for a message category and topic.
</pre></div></div><div class="public anchor" id="var-broadcast-event.21"><h3>broadcast-event!</h3><div class="usage"><code>(broadcast-event! topic event excludes)</code></div><div class="doc"><pre class="plaintext">Sends an event message to all clients in a topic but those excluded.
</pre></div></div><div class="public anchor" id="var-client-auth-requested.3F"><h3>client-auth-requested?</h3><div class="usage"><code>(client-auth-requested? sess-id)</code></div><div class="doc"><pre class="plaintext">Checks if the authreq call has already occurred.
</pre></div></div><div class="public anchor" id="var-client-authenticated.3F"><h3>client-authenticated?</h3><div class="usage"><code>(client-authenticated? sess-id)</code></div><div class="doc"><pre class="plaintext">Checks if authentication has occurred.
</pre></div></div><div class="public anchor" id="var-client-topics"><h3>client-topics</h3><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-emit-event.21"><h3>emit-event!</h3><div class="usage"><code>(emit-event! topic event includes)</code></div><div class="doc"><pre class="plaintext">Sends an event message to specific clients in a topic
</pre></div></div><div class="public anchor" id="var-get-topic-clients"><h3>get-topic-clients</h3><div class="usage"><code>(get-topic-clients topic)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-handle-message"><h3>handle-message</h3><h4 class="type">multimethod</h4><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-hmac-sha-256"><h3>hmac-sha-256</h3><div class="usage"><code>(hmac-sha-256 key data)</code></div><div class="doc"><pre class="plaintext">Generates a HMAC SHA256 hash.
</pre></div></div><div class="public anchor" id="var-http-kit-handler"><h3>http-kit-handler</h3><div class="usage"><code>(http-kit-handler channel callbacks-map)</code></div><div class="doc"><pre class="plaintext">Sets up the necessary http-kit websocket event handlers
for use with the WAMP sub-protocol. Returns a WAMP client session id.

Example usage:

  (http-kit/with-channel req channel
    (if-not (:websocket? req)
      (http-kit/close channel)
      (http-kit-handler channel
        {:on-open        on-open-fn
         :on-close       on-close-fn

         :on-auth        {:allow-anon?     false         ; allow anonymous authentication?
                          :timeout         20000         ; close connection if not authenticated
                                                         ; (default 20 secs)
                          :secret          auth-secret-fn
                          :permissions     auth-permissions-fn}

         :on-call        {(rpc-url "add")      +         ; map topics to rpc functions
                          (rpc-url "echo")     identity
                          :on-before           on-before-call-fn
                          :on-after-error      on-after-call-error-fn
                          :on-after-success    on-after-call-success-fn}

         :on-subscribe   {(evt-url "chat")     on-subscribe-fn? ; allowed to subscribe?
                          (evt-url "prefix*")  true             ; match topics by prefix
                          (evt-url "sub-only") true             ; implicitly allowed
                          (evt-url "pub-only") false            ; subscription is denied
                          :on-after            on-after-subscribe-fn};

         :on-publish     {(evt-url "chat")     on-publish-fn   ; custom event broker
                          (evt-url "prefix*")  true            ; pass events through as-is
                          (evt-url "sub-only") false           ; publishing is denied
                          (evt-url "pub-only") true
                          :on-after            on-after-publish-fn}

         :on-unsubscribe on-unsubscribe-fn})))

Callback signatures:

  (on-open-fn sess-id)
  (on-close-fn sess-id status)

  (auth-secret-fn sess-id auth-key auth-extra)
    Provide the authentication secret for the key (ie. username) and
    (optionally) extra information from the client. Return nil if the key
    does not exist.

  (auth-permissions-fn sess-id auth-key)
    Returns a map of permissions the session is granted when the authentication
    succeeds for the given key.

    The permission map should be comprised of the topics that are allowed
    for each category:

      {:rpc       {"<a href="http://example/rpc#call&quot;">http://example/rpc#call"</a>;    true}
       :subscribe {"<a href="http://example/event#allow&quot;">http://example/event#allow"</a>; true
                   "<a href="http://example/event#deny&quot;">http://example/event#deny"</a>;  false}
       :publish   {"<a href="http://example/event#allow&quot;">http://example/event#allow"</a>; true}}

    ...or you can allow all category topics:

      {:all true}

    ...or allow/deny all topics within a category:

      {:rpc       true
       :subscribe false
       :publish   true}

  (rpc-call ...)
    Can have any signature. The parameters received from the client will be applied as-is.
    The client session is also available in the bound *call-sess-id* var.
    The function may return a value as is, or in a result map: {:result "my result"},
    or as an error map: {:error {:uri "<a href="http://example.com/error#give-error&quot;">http://example.com/error#give-error"</a>;
                                 :message "Test error"
                                 :description "Test error description"
                                 :kill false}} ; true will close the connection after send

  (on-before-call-fn sess-id topic call-id call-params)
    To allow call, return params as vector: [sess-id topic call-id call-params]
    To deny, return nil/false.

  (on-after-call-error-fn sess-id topic call-id error)
    Return params as vector: [sess-id topic call-id error]

  (on-after-call-success-fn sess-id topic call-id result)
    Return params as vector: [sess-id topic call-id result]

  (on-subscribe-fn? sess-id topic)
    Return true to allow client to subscribe, false to deny.

  (on-after-subscribe-fn sess-id topic)
    No return values required.

  (on-publish-fn sess-id topic event exclude eligible)
    To allow publish, return params as vector: [sess-id topic event exclude eligible]
    To deny, return nil/false.

  (on-after-publish-fn sess-id topic event exclude eligible)
    No return values required.

  (on-unsubscribe-fn sess-id topic)
    No return values required.</pre></div></div><div class="public anchor" id="var-origin-match.3F"><h3>origin-match?</h3><div class="usage"><code>(origin-match? origin-re req)</code></div><div class="doc"><pre class="plaintext">Compares a regular expression against the Origin: header.
Used to help protect against CSRF, but do not depend on just
this check. Best to use a server-generated CSRF token for comparison.</pre></div></div><div class="public anchor" id="var-send-abort.21"><h3>send-abort!</h3><div class="usage"><code>(send-abort! sess-id details-dict reason-uri)</code></div><div class="doc"><pre class="plaintext">Sends an ABORT message to abort opening a session.
</pre></div></div><div class="public anchor" id="var-send-call-result.21"><h3>send-call-result!</h3><div class="usage"><code>(send-call-result! sess-id call-id result)</code></div><div class="doc"><pre class="plaintext">Sends a WAMP call result message to a websocket client.
[RESULT, CALL.Request|id, Details|dict]
[RESULT, CALL.Request|id, Details|dict, YIELD.Arguments|list]
[RESULT, CALL.Request|id, Details|dict, YIELD.Arguments|list, YIELD.ArgumentsKw|dict]</pre></div></div><div class="public anchor" id="var-send-error.21"><h3>send-error!</h3><div class="usage"><code>(send-error! sess-id call-id error-info error-uri)</code></div><div class="doc"><pre class="plaintext">Sends a WAMP call error message to a websocket client.
[ERROR, CALL, CALL.Request|id, Details|dict, Error|uri]
[ERROR, CALL, CALL.Request|id, Details|dict, Error|uri, Arguments|list]
[ERROR, CALL, CALL.Request|id, Details|dict, Error|uri, Arguments|list, ArgumentsKw|dict]</pre></div></div><div class="public anchor" id="var-send-event.21"><h3>send-event!</h3><div class="usage"><code>(send-event! topic event)</code></div><div class="doc"><pre class="plaintext">Sends an event message to all clients in topic.
[EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,
     Details|dict]
[EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,
     Details|dict, PUBLISH.Arguments|list]
[EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,
     Details|dict, PUBLISH.Arguments|list, PUBLISH.ArgumentKw|dict]</pre></div></div><div class="public anchor" id="var-send-goodbye.21"><h3>send-goodbye!</h3><div class="usage"><code>(send-goodbye! sess-id details-dict reason-uri)</code></div><div class="doc"><pre class="plaintext">Send a GOODBYE message
</pre></div></div><div class="public anchor" id="var-send-subscribed.21"><h3>send-subscribed!</h3><div class="usage"><code>(send-subscribed! sess-id request-id subscription-id)</code></div><div class="doc"><pre class="plaintext">Sends a WAMP SUBSCRIBED message to a websocket client.
[SUBSCRIBED, SUBSCRIBE.Request|id, Subscription|id]</pre></div></div><div class="public anchor" id="var-send-welcome.21"><h3>send-welcome!</h3><div class="usage"><code>(send-welcome! sess-id)</code></div><div class="doc"><pre class="plaintext">Sends a WAMP welcome message to a websocket client.
[WELCOME, Session|id, Details|dict]</pre></div></div><div class="public anchor" id="var-subprotocol-id"><h3>subprotocol-id</h3><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-subprotocol.3F"><h3>subprotocol?</h3><div class="usage"><code>(subprotocol? proto req)</code></div><div class="doc"><pre class="plaintext">Checks if a protocol string exists in the Sec-WebSocket-Protocol
list header.</pre></div></div><div class="public anchor" id="var-topic-clients"><h3>topic-clients</h3><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-topic-subscribe"><h3>topic-subscribe</h3><div class="usage"><code>(topic-subscribe topic sess-id request-id)</code></div><div class="doc"><pre class="plaintext">Subscribes a websocket session to a topic.
</pre></div></div><div class="public anchor" id="var-topic-unsubscribe"><h3>topic-unsubscribe</h3><div class="usage"><code>(topic-unsubscribe topic sess-id)</code></div><div class="doc"><pre class="plaintext">Unsubscribes a websocket session from a topic.
</pre></div></div><div class="public anchor" id="var-with-channel-validation"><h3>with-channel-validation</h3><h4 class="type">macro</h4><div class="usage"><code>(with-channel-validation request ch-name origin-re &amp; body)</code></div><div class="doc"><pre class="plaintext">Replaces the HTTP Kit `with-channel` macro. Does extra validation
to match the wamp subprotocol and origin URL matching.

Example usage:

  (defn my-wamp-handler [request]
    (wamp/with-channel-validation request channel #"https?://myhost"
      (wamp/http-kit-handler channel { ... })))

See org.httpkit.server for more information.</pre></div></div></div></body></html>